name: Docker Build And Push

on:
  push:
    branches:
      - 'main'

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
    
      - name: "⤵️ Clone the product repo"
        uses: actions/checkout@v3
        with:
          path: 'this_repo'
          ref: ${{ github.ref_name }}
          
      - name: "🛠 Build and push dockerfile(s)"
        run: |
          DEPLOYREPO=${GITHUB_REPOSITORY##*/}
          DEPLOYREPOLOWER=${DEPLOYREPO,,}
          if compgen -G "$GITHUB_WORKSPACE/this_repo/*.dockerfile" > /dev/null ; then
            for d in $GITHUB_WORKSPACE/this_repo/*/; do
              echo "$d"
              echo -= 💻 Found "$FILENAME" =-
              cd $d
              echo -= 💻 Get repo name =-
              ECRREPO=$(aws ecr describe-repositories --query 'repositories[].repositoryUri[]' --region $AWS_DEFAULT_REGION | grep $DEPLOYREPOLOWER-$FILENAMEWITHOUTEXTENSION | sed 's/"//g' | sed 's/,//g' | sed -r 's/\s+//g')
              REPOHOSTNAME=$(echo $ECRREPO | cut -f1 -d/)
              echo -= 💻 Login to ECR via Docker client =-
              aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $REPOHOSTNAME
              echo -= 💻 Build "$FILENAME" =-
              docker build -t $ECRREPO:latest -f $FILENAME .
              echo -= 💻 Push "$FILENAME" =-
              docker push $ECRREPO:latest
            done
          else
            echo "-= 🔨 There are no dockerfiles, skipping step =-"
          fi
