name: Docker Build And Push

on:
  push:
    branches:
      - 'main'

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
    
      - name: "‚§µÔ∏è Clone the product repo"
        uses: actions/checkout@v3
        with:
          path: 'this_repo'
          ref: ${{ github.ref_name }}
          
      - name: "üõ† Build and push dockerfile(s)"
        run: |
          DEPLOYREPO=${GITHUB_REPOSITORY##*/}
          DEPLOYREPOLOWER=${DEPLOYREPO,,}
            for d in $GITHUB_WORKSPACE/this_repo/*/; do
              echo "$d"
              DIRWITHOUTTRAILINGSLASH=${d/%//}
              REPONAME=${DIRWITHOUTTRAILINGSLASH##*/}
              echo "$REPONAME"
              echo -= üíª Found "$FILENAME" =-
              cd "$d"
              echo -= üíª Login to ECR via Docker client =-
              echo secrettoke | docker login -u sfriedel --password-stdin
              echo -= üíª Build "$FILENAME" =-
              docker build -t sfriedel/$REPONAME:latest .
              echo -= üíª Push "$FILENAME" =-
              docker push sfriedel/$REPONAME:latest
            done
